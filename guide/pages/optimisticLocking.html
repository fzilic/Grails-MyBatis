<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
                      "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
    <title>4.1 Optimistic locking 0.0.3</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <link rel="stylesheet" href="../css/main.css" type="text/css" media="screen, print" title="Style" charset="utf-8"/>
    <link rel="stylesheet" href="../css/pdf.css" type="text/css" media="print" title="PDF" charset="utf-8"/>
    <script type="text/javascript">
function addJsClass() {
    var classes = document.body.className.split(" ");
    classes.push("js");
    document.body.className = classes.join(" ");
}
    </script>
</head>

<body class="body" onload="addJsClass();">
<div id="navigation">
    <ul>
        <li>
            <div id="nav-summary" onmouseover="toggleNavSummary(false)" onmouseout="toggleNavSummary(true)">
                <a href="../../guide/index.html" class="button">Table of contents</a>

                <div id="nav-summary-childs" style="display:none;">
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/introduction.html"><strong>1</strong><span>Introduction</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/gettingStarted.html"><strong>2</strong><span>Getting Started</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/workingWithMyBatis.html"><strong>3</strong><span>Working with MyBatis</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0"><a href="../../guide/pluginFeatures.html"><strong>4</strong><span>Plugin features</span></a>
                    </div>
                    
                </div>
            </div>
        </li>
        <li class="separator selected">
            <a id="ref-button" onclick="localToggle(); return false;" href="#">Quick Reference</a>
        </li>
    </ul>
</div>
<div id="header">
    <div class="images clearfix">
        
        
    </div>
    <p>The MyBatis plugin enables Grails integration with MyBatis ORM framework
</p>
</div>


<table id="colset" border="0" cellpadding="0" cellspacing="0">
    <tr>
        <td id="col1">
            <div id="main" class="corner-all">

                
                    <div class="toc-item prev-left"><a href="../../guide/workingWithMyBatis.html">&lt;&lt; <strong>3</strong><span>Working with MyBatis</span></a></div>
                

                <span id='toggle-col1' class="toggle">(<a href="#" onclick="localToggle(); return false;">Quick Reference</a>)</span>

                


                <div class="project">
                    <h1>4.1 Optimistic locking - Reference Documentation</h1>

                    <p><strong>Authors:</strong> Franjo Žilić</p>

                    <p><strong>Version:</strong> 0.0.3</p>

                    
                </div>

                

                

<h2 id="optimisticLocking">4.1 Optimistic locking</h2>
Optimistic locking in this plugin is based on Hibernate optimistic locking idea.<p class="paragraph"/>To enable optimistic locking for our Person class we have to add id and version properties and static that enables optimistic locking for this class.<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">package</span> org.grails.mybatis.example<p class="paragraph"/>class Person &#123;
  def <span class="java&#45;keyword">static</span> useOptimisticLocking = <span class="java&#45;keyword">true</span><p class="paragraph"/>  <span class="java&#45;object">Integer</span> id
  <span class="java&#45;object">Integer</span> version
  <span class="java&#45;object">String</span> firstName
  <span class="java&#45;object">String</span> lastName
  <span class="java&#45;object">Integer</span> age
&#125;</pre></div><p class="paragraph"/>We have to modify our mapping xml to support optimistic locking and new properties.
Simply querying for object version is not enough so we should also add an insert and update query.<p class="paragraph"/><div class="code"><pre><span class="xml&#45;tag">&#60;?xml version=<span class="xml&#45;quote">"1.0"</span> encoding=<span class="xml&#45;quote">"UTF&#45;8"</span> ?&#62;</span>
&#60;!DOCTYPE mapper PUBLIC <span class="xml&#45;quote">"&#45;//mybatis.org//DTD Mapper 3.0//EN"</span> <span class="xml&#45;quote">"http://mybatis.org/dtd/mybatis&#45;3&#45;mapper.dtd"</span>&#62;
<span class="xml&#45;tag">&#60;mapper namespace=<span class="xml&#45;quote">"org.grails.mybatis.example.person"</span>&#62;</span><p class="paragraph"/>  <span class="xml&#45;tag">&#60;select id=<span class="xml&#45;quote">"loadCurrentVersionOfPersonById"</span> resultType=<span class="xml&#45;quote">"integer"</span> parameterType=<span class="xml&#45;quote">"integer"</span>&#62;</span>
    SELECT VERSION
    FROM PERSON
    WHERE ID = &#35;&#123;value&#125;
  <span class="xml&#45;tag">&#60;/select&#62;</span><p class="paragraph"/>  <span class="xml&#45;tag">&#60;select id=<span class="xml&#45;quote">"loadAllPersonList"</span> resultMap=<span class="xml&#45;quote">"basicPersonMap"</span>&#62;</span>
    SELECT &#42; FROM PERSON
  <span class="xml&#45;tag">&#60;/select&#62;</span><p class="paragraph"/>  <span class="xml&#45;tag">&#60;select id=<span class="xml&#45;quote">"loadPersonById"</span> resultMap=<span class="xml&#45;quote">"basicPersonMap"</span>&#62;</span>
    SELECT &#42; FROM PERSON WHERE ID = &#35;&#123;value&#125;
  <span class="xml&#45;tag">&#60;/select&#62;</span><p class="paragraph"/>  <span class="xml&#45;tag">&#60;resultMap type=<span class="xml&#45;quote">"org.grails.mybatis.example.Person"</span> id=<span class="xml&#45;quote">"basicPersonMap"</span>&#62;</span>
    <span class="xml&#45;tag">&#60;id property=<span class="xml&#45;quote">"id"</span> column=<span class="xml&#45;quote">"ID"</span> javaType=<span class="xml&#45;quote">"Integer"</span> /&#62;</span>
    <span class="xml&#45;tag">&#60;result property=<span class="xml&#45;quote">"version"</span> column=<span class="xml&#45;quote">"VERSION"</span> javaType=<span class="xml&#45;quote">"Integer"</span>/&#62;</span>
    <span class="xml&#45;tag">&#60;result property=<span class="xml&#45;quote">"firstName"</span> column=<span class="xml&#45;quote">"FIRST_NAME"</span> /&#62;</span>
    <span class="xml&#45;tag">&#60;result property=<span class="xml&#45;quote">"lastName"</span> column=<span class="xml&#45;quote">"LAST_NAME"</span>/&#62;</span>
    <span class="xml&#45;tag">&#60;result property=<span class="xml&#45;quote">"age"</span> column=<span class="xml&#45;quote">"AGE"</span>/&#62;</span>
  <span class="xml&#45;tag">&#60;/resultMap&#62;</span><p class="paragraph"/>  <span class="xml&#45;tag">&#60;insert id=<span class="xml&#45;quote">"insertPerson"</span> parameterType=<span class="xml&#45;quote">"org.grails.mybatis.example.Person"</span>&#62;</span>
    <span class="xml&#45;tag">&#60;selectKey keyProperty=<span class="xml&#45;quote">"id"</span> resultType=<span class="xml&#45;quote">"integer"</span> order=<span class="xml&#45;quote">"BEFORE"</span>&#62;</span>
      SELECT COALESCE(MAX(ID), 0) + 1 FROM PERSON
    <span class="xml&#45;tag">&#60;/selectKey&#62;</span>
    INSERT INTO PERSON (ID, VERSION, FIRST_NAME, LAST_NAME, AGE)
    VALUES (&#35;&#123;id&#125;, &#35;&#123;version&#125;, &#35;&#123;firstName&#125;, &#35;&#123;lastName&#125;, &#35;&#123;age&#125;)
  <span class="xml&#45;tag">&#60;/insert&#62;</span><p class="paragraph"/>  <span class="xml&#45;tag">&#60;update id=<span class="xml&#45;quote">"updatePerson"</span> parameterType=<span class="xml&#45;quote">"org.grails.mybatis.example.Person"</span>&#62;</span>
    UPDATE PERSON
    SET VERSION = &#35;&#123;version&#125;, FIRST_NAME = &#35;&#123;firstName&#125;, LAST_NAME = &#35;&#123;lastName&#125;, AGE = &#35;&#123;age&#125;
    WHERE ID = &#35;&#123;id&#125;
  <span class="xml&#45;tag">&#60;/update&#62;</span><p class="paragraph"/><span class="xml&#45;tag">&#60;/mapper&#62;</span></pre></div><p class="paragraph"/>Now we can modify PersonGatewayTests<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">package</span> org.grails.mybatis.example<p class="paragraph"/><span class="java&#45;keyword">import</span> groovy.sql.Sql<p class="paragraph"/>class PersonGatewayTests <span class="java&#45;keyword">extends</span> GroovyTestCase &#123;<p class="paragraph"/>  /&#42;&#42;
   &#42; Dependency injection is used to test Gateway artefacts
   &#42;/
  def dataSource
  def personGateway<p class="paragraph"/>  <span class="java&#45;keyword">protected</span> void setUp() <span class="java&#45;keyword">throws</span> Exception &#123;
    def sql = <span class="java&#45;keyword">new</span> Sql(dataSource)
    sql.execute(<span class="java&#45;quote">""</span><span class="java&#45;quote">"CREATE TABLE PERSON (
    ID INTEGER NOT NULL,
    VERSION INTEGER NOT NULL,
    FIRST_NAME VARCHAR(30),
    LAST_NAME VARCHAR(30),
    AGE INTEGER,
    PRIMARY KEY (ID)
    )"</span><span class="java&#45;quote">""</span>)
  &#125;<p class="paragraph"/>  <span class="java&#45;keyword">protected</span> void tearDown() <span class="java&#45;keyword">throws</span> Exception &#123;
    def sql = <span class="java&#45;keyword">new</span> Sql(dataSource)
    sql.execute(<span class="java&#45;quote">""</span><span class="java&#45;quote">"DROP TABLE IF EXISTS PERSON"</span><span class="java&#45;quote">""</span>)
  &#125;<p class="paragraph"/>  void testDependencies() &#123;
    assert dataSource
    assert personGateway
  &#125;<p class="paragraph"/>  void testPersonInsert() &#123;
    Person data = <span class="java&#45;keyword">new</span> Person(firstName: 'John', lastName: 'Doe', age: 50)<p class="paragraph"/>    personGateway.insertPerson(data);<p class="paragraph"/>    def databaseData = <span class="java&#45;keyword">new</span> Sql(dataSource).firstRow(<span class="java&#45;quote">"SELECT &#42; FROM PERSON"</span>)<p class="paragraph"/>    assert databaseData&#91;<span class="java&#45;quote">"ID"</span>&#93; == 1
    assert databaseData&#91;<span class="java&#45;quote">"VERSION"</span>&#93; == 1
    assert databaseData&#91;<span class="java&#45;quote">"FIRST_NAME"</span>&#93; == 'John'
    assert databaseData&#91;<span class="java&#45;quote">"LAST_NAME"</span>&#93; == 'Doe'
    assert databaseData&#91;<span class="java&#45;quote">"AGE"</span>&#93; == 50<p class="paragraph"/>    assert data.id == 1
    assert data.version == 1
  &#125;<p class="paragraph"/>  void testLoadPersonById() &#123;
    Person data = <span class="java&#45;keyword">new</span> Person(firstName: 'John', lastName: 'Doe', age: 50)<p class="paragraph"/>    personGateway.insertPerson(data);<p class="paragraph"/>    Person fromDb = personGateway.loadPersonById(data.id)<p class="paragraph"/>    assert fromDb
    assert fromDb.id == data.id
    assert fromDb.version == data.version
    assert fromDb.firstName == data.firstName
  &#125;<p class="paragraph"/>  void testPersonUpdate() &#123;
    Person data = <span class="java&#45;keyword">new</span> Person(firstName: 'John', lastName: 'Doe', age: 50)<p class="paragraph"/>    personGateway.insertPerson(data);<p class="paragraph"/>    assert data.version == 1
    assert data.age == 50<p class="paragraph"/>    Person fromDb = personGateway.loadPersonById(data.id)<p class="paragraph"/>    assert fromDb.id == 1
    assert fromDb.version == 1
    assert fromDb.age == 50<p class="paragraph"/>    data.age = 33<p class="paragraph"/>    personGateway.updatePerson(data)<p class="paragraph"/>    assert data.version == 2
    assert data.age == 33<p class="paragraph"/>    fromDb = personGateway.loadPersonById(data.id)<p class="paragraph"/>    assert fromDb.version == 2
    assert fromDb.age == 33<p class="paragraph"/>    <span class="java&#45;keyword">new</span> Sql(dataSource).execute(<span class="java&#45;quote">"UPDATE PERSON SET VERSION = 7, AGE = 29 WHERE ID = 1"</span>)<p class="paragraph"/>    shouldFail &#123;
      data.firstName = 'Mark'
      personGateway.updatePerson(data)
    &#125;<p class="paragraph"/>  &#125;<p class="paragraph"/>  void testLoadAllPersonList() &#123;
    personGateway.insertPerson(<span class="java&#45;keyword">new</span> Person(firstName: 'John', lastName: 'Doe', age: 20))
    personGateway.insertPerson(<span class="java&#45;keyword">new</span> Person(firstName: 'Mark', lastName: 'Miles', age: 23))<p class="paragraph"/>    def results = personGateway.loadAllPersonList()<p class="paragraph"/>    assert results
    assert results.size() == 2
    assert results&#91;0&#93; <span class="java&#45;keyword">instanceof</span> Person
    assert results&#91;0&#93;.firstName == 'John'
    assert results&#91;1&#93;.firstName == 'Mark'
  &#125;<p class="paragraph"/>&#125;</pre></div>



                <div style="clear:both;margin-top:15px;"></div>
                
                    <div class="toc-item prev-left"><a href="../../guide/workingWithMyBatis.html">&lt;&lt; <strong>3</strong><span>Working with MyBatis</span></a></div>
                
                <div style="clear:both"></div>
            </div>
        </td>
        <td id="col2">
            <div class="local clearfix">
                <div class="local-title">
                    <a href="../../guide/index.html" target="mainFrame">Quick Reference</a>
                    <span class="toggle">(<a href="#" onclick="localToggle(); return false;">hide</a>)</span>
                </div>
                <div class="menu">
                    
                    <div class="menu-block"><h1 class="menu-title" onclick="toggleRef(this.parentNode.childNodes[1])">Samples</h1><div class="menu-sub">
                        
                            
                            <div class="menu-item"><a href="../../ref/Samples/Gateway.html">Gateway</a>
                            </div>
                            
                            <div class="menu-item"><a href="../../ref/Samples/Mapper%20XML.html">Mapper XML</a>
                            </div>
                            
                            <div class="menu-item"><a href="../../ref/Samples/MyBatisDomainClass.html">MyBatisDomainClass</a>
                            </div>
                            
                            <div class="menu-item"><a href="../../ref/Samples/TypeHandlers.html">TypeHandlers</a>
                            </div>
                            
                            </div>
                    </div>
                    
                </div>
            </div>
        </td>
    </tr>
</table>

<div id="footer">
    
    
</div>

<script type="text/javascript" src="../js/docs.js"></script>

</body>
</html>
